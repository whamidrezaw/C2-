<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://telegram.org; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self';">
    <title>Time Manager Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="/static/style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<div class="container">
    <div class="header-card">
        <div class="clock" id="clock">--:--</div>
        <div class="date-display" id="date-display">Loading...</div>
        <div class="quote" id="quote-display">Initializing...</div>
    </div>
    
    <div id="list">
        <div class="empty-state">
            <div style="font-size:40px; margin-bottom:10px;">‚è≥</div>
            Loading events...
        </div>
    </div>
</div>

<div class="bottom-bar">
    <button class="action-btn btn-del" onclick="toggleDeleteMode()">üóë Delete</button>
    <button class="action-btn btn-add" onclick="triggerAdd()">‚ûï Add Event</button>
</div>

<script>
    // ==================== SETUP & SECURITY ====================
    const tg = window.Telegram.WebApp; 
    tg.expand(); 

    // Security check: Must be opened in Telegram
    if (!tg.initData) {
        document.body.innerHTML = "<h3 style='text-align:center; padding:50px;'>‚õî Access Denied<br>Please open in Telegram.</h3>";
        throw new Error("Not in Telegram");
    }

    const initData = tg.initData; 
    const userData = JSON.parse('{{ user_data | tojson | safe }}');
    let isDeleteMode = false;

    // XSS Protection
    function escapeHtml(text) {
        if (!text) return text;
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // ==================== UI UTILS ====================
    const quotes = [
        "Make it happen.", "Seize the day.", "Time is gold.", "Stay focused.",
        "Dream big.", "Keep going.", "You can do it.", "Believe in yourself.",
        "Action wins.", "No excuses.", "Create the future.", "Stay hungry."
    ];
    document.getElementById('quote-display').innerText = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;

    function updateClock() {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
        document.getElementById('date-display').innerText = now.toLocaleDateString('en-GB', {weekday:'long', day:'numeric', month:'long'});
    }
    
    const clockInterval = setInterval(updateClock, 1000); 
    updateClock();
    
    // Cleanup on unload
    window.addEventListener('beforeunload', () => clearInterval(clockInterval));

    // Fetch with timeout
    async function fetchWithTimeout(resource, options = {}) {
        const { timeout = 8000 } = options;
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        
        try {
            const response = await fetch(resource, {
                ...options,
                signal: controller.signal  
            });
            clearTimeout(id);
            return response;
        } catch (error) {
            clearTimeout(id);
            throw error;
        }
    }

    // ==================== ACTIONS ====================
    async function triggerAdd() {
        if (isDeleteMode) toggleDeleteMode();

        const title = prompt("Enter Event Name (Max 50 chars):");
        if (!title) return;
        if (title.length > 50) {
            alert("Title is too long!");
            return;
        }

        const date = prompt("Enter Date (Examples: 2025.12.30 or 1404.01.01):");
        if (!date) return;
        
        tg.MainButton.showProgress();
        
        try {
            const res = await fetchWithTimeout(`/api/add`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ initData: initData, title: title, date: date })
            });
            
            const json = await res.json();
            if (json.success) {
                tg.HapticFeedback.notificationOccurred('success');
                window.location.reload();
            } else {
                tg.HapticFeedback.notificationOccurred('error');
                alert("Error: " + (json.error || "Invalid Data"));
            }
        } catch (e) {
            alert("Connection Error or Timeout");
        }
        
        tg.MainButton.hideProgress();
    }

    // ‚úÖ ÿßÿµŸÑÿßÿ≠ ÿ¥ÿØŸá: ÿÆŸàÿßŸÜÿØŸÜ ÿπŸÜŸàÿßŸÜ ÿßÿ≤ userData ÿ®Ÿá ÿ¨ÿß€å onclick
    async function deleteEvent(key) {
        const title = userData[key] ? userData[key].title : "Event";
        
        if (!confirm(`Delete "${title}"?`)) return;
        
        tg.MainButton.showProgress();
        
        try {
            const res = await fetchWithTimeout(`/api/delete`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ initData: initData, key: key })
            });
            
            if (res.ok) {
                tg.HapticFeedback.notificationOccurred('success');
                const card = document.querySelector(`[data-key="${key}"]`);
                if (card) {
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        card.remove();
                        if (document.querySelectorAll('.card').length === 0) {
                            window.location.reload();
                        }
                    }, 300);
                }
            } else {
                alert("Failed to delete");
            }
        } catch (e) {
            alert("Connection Error");
        }
        
        tg.MainButton.hideProgress();
    }

    // ==================== RENDER ====================
    const listDiv = document.getElementById('list');
    
    if (!userData || Object.keys(userData).length === 0) {
        listDiv.innerHTML = `
            <div class="empty-state">
                <div style="font-size:40px; margin-bottom:10px;">üìÖ</div>
                No events yet.<br>Tap "Add Event" to start.
            </div>`;
    } else {
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        
        const events = Object.entries(userData).map(([key, item]) => {
            try {
                const parts = item.date.split('.'); 
                const target = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                const diff = Math.ceil((target - now) / 86400000);
                return { ...item, key, diff };
            } catch { 
                return { ...item, key, diff: 0 }; 
            }
        }).sort((a, b) => a.diff - b.diff);

        let html = '';
        events.forEach(item => {
            let cls = 'bg-green';
            let txt = item.diff + " Days";

            if (item.diff < 0) {
                cls = 'bg-gray';
                txt = "Done";
            } else if (item.diff === 0) {
                cls = 'bg-red';
                txt = "Today!";
            } else if (item.diff < 30) {
                cls = 'bg-red';
            } else if (item.diff <= 180) {
                cls = 'bg-yellow';
            }

            const shamsiPart = item.shamsi_date ? 
                `<div class="date-item"><span class="date-label">‚òÄÔ∏è IR:</span> ${item.shamsi_date}</div>` : '';

            // ‚úÖ ÿßÿµŸÑÿßÿ≠ ÿ¥ÿØŸá: onclick ŸÅŸÇÿ∑ key ÿ±ÿß ŸÖ€å‚ÄåŸÅÿ±ÿ≥ÿ™ÿØ
            html += `
            <div class="card" data-key="${item.key}" onclick="if(isDeleteMode) deleteEvent('${item.key}')">
                <div style="font-size: 24px;">üìå</div>
                <div class="card-info">
                    <div class="card-title">${escapeHtml(item.title)}</div>
                    <div class="date-row">
                        <div class="date-item"><span class="date-label">üìÖ EN:</span> ${item.date}</div>
                        ${shamsiPart}
                    </div>
                </div>
                <div class="badge ${cls}">${txt}</div>
                <div class="del-overlay">üóë</div>
            </div>`;
        });
        
        listDiv.innerHTML = html;
    }

    function toggleDeleteMode() {
        isDeleteMode = !isDeleteMode;
        const list = document.getElementById('list');
        const btnDel = document.querySelector('.btn-del');
        
        if (isDeleteMode) {
            list.classList.add('delete-mode');
            btnDel.innerText = "Done";
            btnDel.style.borderColor = "var(--danger-color)";
            tg.HapticFeedback.impactOccurred('medium');
        } else {
            list.classList.remove('delete-mode');
            btnDel.innerText = "üóë Delete";
            btnDel.style.borderColor = "#f3f4f6";
        }
    }
    
    // ==================== THEME ====================
    if (tg.themeParams.bg_color) {
        document.body.style.background = tg.themeParams.secondary_bg_color;
        document.documentElement.style.setProperty('--card-bg', tg.themeParams.bg_color);
        document.documentElement.style.setProperty('--text-primary', tg.themeParams.text_color);
        document.documentElement.style.setProperty('--text-secondary', tg.themeParams.hint_color);
        if (tg.themeParams.button_color) {
            document.documentElement.style.setProperty('--accent-color', tg.themeParams.button_color);
        }
    }
</script>
</body>
</html>
