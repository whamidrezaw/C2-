<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            font-family: Tahoma, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            user-select: none;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        h2 {
            text-align: center;
            color: var(--tg-theme-button-color, #3390ec);
        }
        .clock-box {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 20px;
            padding: 10px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 10px;
        }
        .card {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .title {
            font-weight: bold;
            font-size: 1.1em;
        }
        .date {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color, #999);
        }
        .countdown {
            font-weight: bold;
            color: var(--tg-theme-button-color, #3390ec);
            direction: ltr; /* Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ø§Ø´Ù†Ø¯ */
            text-align: left;
        }
        .quote-box {
            margin-top: 30px;
            font-style: italic;
            text-align: center;
            opacity: 0.8;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯</h2>
    
    <div class="clock-box" id="clock">
        Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø§Ø¹Øª...
    </div>

    <div id="events-list">
        <div style="text-align: center; margin-top: 20px;">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</div>
    </div>

    <div class="quote-box" id="quote">
        ...
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand(); // ØªÙ…Ø§Ù… ØµÙØ­Ù‡ Ø´Ø¯Ù†

    // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ù¾Ø§ÛŒØªÙˆÙ† (Ú©Ù‡ Ø¯Ø± HTML ØªØ²Ø±ÛŒÙ‚ Ø´Ø¯Ù‡)
    // Ø¯Ø± ÙˆØ§Ù‚Ø¹ Ù¾Ø§ÛŒØªÙˆÙ† Ù…ØªØºÛŒØ±Ù‡Ø§ Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø§ÛŒÙ† Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    const userData = {{ user_data | tojson }};
    const userLang = "{{ lang }}";

    // ØªÙ†Ø¸ÛŒÙ… Ø³Ø§Ø¹Øª
    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString(userLang === 'de' ? 'de-DE' : 'fa-IR');
        document.getElementById('clock').innerText = (userLang === 'de' ? 'Uhrzeit: ' : 'Ø³Ø§Ø¹Øª: ') + timeString;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Ø³Ø§Ø®Øª Ù„ÛŒØ³Øª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
    const listDiv = document.getElementById('events-list');
    listDiv.innerHTML = '';

    if (Object.keys(userData).length === 0) {
        listDiv.innerHTML = '<p style="text-align:center">Ù„ÛŒØ³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª / Liste ist leer</p>';
    } else {
        for (const [key, item] of Object.entries(userData)) {
            const title = item.labels[userLang] || item.labels['en'];
            const dateStr = item.date; // DD.MM.YYYY
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆØ² Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ (Ø³Ø§Ø¯Ù‡)
            const parts = dateStr.split('.');
            const targetDate = new Date(parts[2], parts[1]-1, parts[0]);
            const now = new Date();
            const diffTime = targetDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let daysText = diffDays > 0 ? diffDays + (userLang === 'de' ? ' Tage' : ' Ø±ÙˆØ²') : (userLang === 'de' ? 'Heute!' : 'Ø§Ù…Ø±ÙˆØ²!');
            if (diffDays < 0) daysText = (userLang === 'de' ? 'Vorbei' : 'Ú¯Ø°Ø´ØªÙ‡');

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-header">
                    <span class="title">${item.icon} ${title}</span>
                </div>
                <div class="date">ğŸ“… ${dateStr}</div>
                <div class="countdown">â³ ${daysText}</div>
            `;
            listDiv.appendChild(card);
        }
    }

    // Ù†Ù…Ø§ÛŒØ´ Ø±Ù†Ú¯ ØªÙ… ØªÙ„Ú¯Ø±Ø§Ù…
    document.body.style.backgroundColor = tg.themeParams.bg_color;
</script>

</body>
</html>